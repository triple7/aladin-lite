<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="./aladin.css" />
<script type='text/javascript' src='jquery.js' charset='utf-8'></script>
<script type='text/javascript' src='./aladin.js' charset='utf-8'></script>
    <title>
Viewport</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="aladin based AstreOS sonification">
<meta charset="UTF-8">
</head>

<body>
<div id='aladin-lite-div' style='width: 100%; height:100%;'></div>
<script type="text/javascript">
    
    var aladin = A.aladin('#aladin-lite-div', {survey: "P/DSS2/color", fov:0.5, target: "NGC 1952", showZoomControl: false, showFullscreenControl: false, showLayersControl: false, showGotoControl: false, showShareControl: false, showSimbadPointerControl: false, showCooGrid: false, fullScreen: true, log: true});

    var imageIndex = 0;

    // Setting the function attached to observed mutations
    function sendImage() { 
        console.log("about to send image");
        setTimeout( function() {
            const image = getImage();
            window.webkit.messageHandlers.get_image.postMessage({
                image:image,
                "index": imageIndex
            });
        }, 3000.0);
    }
            
    // Set the base image layer, no alpha transparency by default
    function setBaseImage(hipsID, index) {
        imageIndex = index;
        aladin.setBaseImageLayer(hipsID, index, "source-over", "#000", 1.0);
    }
            
    // Add a new overlay image
    function addSurveylayer(ID, index, blendingMode, hue, alpha) {
        console.log("adding survey layer " + ID + " at index " + index);
        if (index == 0) {
            setBaseImage(ID, index);
        } else if (index > 0) {
            aladin.setImageSurvey(ID, index, blendingMode, hue, alpha);
        }
    }
    
    // Adding a non image survey layer
    function setOverlayImageLayer(hipsID, alpha, index) {
    }

    // Changing the image parameters for a given layer
    function setSurveyParametersAtIndex(index, blend, hue, alpha) {
        aladin.setSurveyParametersAtIndex(index, blend, hue, alpha);
    }
    
    function setCustomSurvey(hipsID, hipsName, url, frame, maxOrder, format, index) {
        imageIndex = index;
    // url can be local or remote
    aladin.setImageSurvey(aladin.createImageSurvey(hipsID, hipsName, url, frame, maxOrder, {imgFormat: format}));
    }
                            
    function setFOV(fov) {
        aladin.setFov(fov);
    }

    function toggleShowSurveyAtIndex(index) {
        aladin.toggleShowSurveyAtIndex(index);
    }

    function getInfo() {
        const raDec = aladin.getRaDec();
        // const size = aladin.getSize();
        // const output = raDec.concat(size);
        // const fov = aladin.getFov();
        // output.push(fov);
        var output = aladin.getFovCorners();
        output.push(raDec);
        window.webkit.messageHandlers.get_info.postMessage({
            info:output
        });
    }

    function goToPosition(ra, dec) {
        aladin.gotoRaDec(ra, dec);
    }

    function goToObject(objectName) {
        console.log('requesting object to aladin');
        aladin.gotoObject(objectName, {success: function() {
            aladin.adjustFovForObject(objectName);
            console.log('success in getting object');
            window.webkit.messageHandlers.go_to_object.postMessage({
                "msg" : objectName+" found",
                "result" : "true"
            });
        }, error: function() {
                window.webkit.messageHandlers.go_to_object.postMessage({
                    "msg" : "cannot resolve object "+objectname,
                    "result" : "false"
                });
            }
        });
    }

    /**
     * Requests images ot be sent to the DESonic app when the zooming or panning
     * to a position where tiles have already loaded.
     */
    function moveUpdateImage() {
        for (const [i, survey] of aladin.view.imageSurveys.entries()) {
            if (survey.view.downloader.tilesToDownload[i] < 0) {
                // will trigger updateImage to be called
                survey.view.downloader.tilesToDownload[i] = 0;
                // aladin.view.requestRedraw(); // Not sure if this is necessary.
            }
        }
    }
        
    function updateImageAtIndex(index, ctx) {
        let img = ctx.canvas.toDataURL('image/jpeg');
        let oldFov = aladin.view.fov;
        let oldPos = aladin.getRaDec();
        setTimeout(function(oldFov, oldPos, img) {
            let newFov = aladin.view.fov;
            let newPos = aladin.getRaDec();

            if (newFov == oldFov && arrayEquals(newPos, oldPos) && 
            aladin.view.downloader.tilesToDownload[index] == 0) {
                window.webkit.messageHandlers.update_image.postMessage({
                    "image" : img,
                    "index": index.toString()
                });
                aladin.view.downloader.tilesToDownload[index] = -1;
            }
        }, 250, oldFov, oldPos, img); // delay may need adjusting
        
    }

    /**
     * compare if two arrays are equal in length, order and value
     */
    function arrayEquals(a, b) {
        return a.length === b.length &&
        a.every((v, i) => v === b[i]);
    }

    function getImage() {
        const image = aladin.getSkymapDataURL('image/jpeg');
        return image;
    }

    function addCatalog(objectName) {
        const url = 'https://cdsxmatch.u-strasbg.fr/QueryCat/QueryCat?catName=SIMBAD&mode=cone&pos='+objectName+'&r=50arcmin&format=votable&limit=3000';
        var cat = A.catalogFromURL(url, {
        sourceSize:12,
            color: '#cc99bb',
            displayLabel: true,
            labelColumn: 'main_id',
            labelColor: '#ae4',
            labelFont: '9px sans-serif'
        });
        console.log("adding catalog from aladin");
        aladin.addCatalog(cat);
    }

    function sendViewCoordinate(RA, DEC, name) {
        const xy = aladin.world2pix(RA, DEC);
        window.webkit.messageHandlers.xy_coordinates.postMessage({
            "x" : xy[0].toString(),
            y : xy[1].toString(),
            "name": name
        });
        
    }
    
    function addMarkers(catName, count, sources) {
        var cat = A.catalog({name: catName, sourceSize: count});
                    aladin.addCatalog(cat);
        for (const s of sources.objects) {
            // console.log('adding '+s.id);
                        sendViewCoordinate(s.coord[0], s.coord[1], s.id);
            cat.addSources([A.marker(s.coord[0], s.coord[1], {popupTitle: s.id}, {name: s.id})]);

        }
    };

    /**
     * Toggles the visibility of the marker canvas
     * 
     * @param {Bool} show   if true, turns on marker canvas. if false, turns off
     *                      marker canvas.
     */
    function showMarkers(show) {
        markerLayers = document.getElementsByClassName("aladin-catalogCanvas");

        console.log("hiding markers...");

        for (var i = 0; i < markerLayers.length; i++) {
            markerLayers[i].style.display = show ? "initial" : "none";
        }
    }

    function setShowGrid(show) {
        aladin.view.setShowGrid(show);
    }

    function testFunc() {
        console.log("TESTING");
    };

    // Listeners

    aladin.on("positionChanged", moveUpdateImage);
    aladin.on("zoomChanged", moveUpdateImage);

    // define function triggered when  a source is hovered
    var currentHover = '';
    aladin.on('objectHovered', function(object) {
        if (object) {
            const detected = object.data.name;
            const x = window.event.clientX;
            const y = window.event.clientY;
            if (detected != currentHover) {
                currentHover = detected;
                window.webkit.messageHandlers.object_detect.postMessage({
                    "object" : detected,
                    "x" : x.toString(),
                    "y" : y.toString()
                });
            }
        } else {
            currentHover = '';
        }
    });

        // aladin.createImageSurvey(
        //     "DES/Mass/1",
        //     "DES Mass 1",
        //     "https://morpheus.astreos.space/DESMass",
        //     "galactic",
        //     3, {imgFormat: "png"});

        // aladin.createImageSurvey(
        //     "P/2MASS/K",
        //     "2MASS K",
        //     "http://alasky.cds.unistra.fr/2MASS/K",
        //     "equatorial",
        //     9, {imgFormat: "jpg"}
        // );

        // aladin.createImageSurvey(
        //     "P/2MASS/H",
        //     "2MASS H",
        //     "http://alasky.cds.unistra.fr/2MASS/H",
        //     "equatorial",
        //     9, {imgFormat: "jpg"}
        // );

        // aladin.createImageSurvey(
        //     "P/2MASS/J",
        //     "2MASS J",
        //     "http://alasky.cds.unistra.fr/2MASS/J",
        //     "equatorial",
        //     9, {imgFormat: "jpg"}
        // );

        // addSurveylayer("DES/Mass/1", 4, "lighten", "#f0f", 1.0);
        // addSurveylayer("P/2MASS/K", 1, "lighten", "#f00", 1.0);
        // addSurveylayer("P/2MASS/H", 2, "lighten", "#0f0", 1.0);
        // addSurveylayer("P/2MASS/J", 3, "lighten", "#00f", 1.0);

// Testing an overlay survey image        

// setTimeout(function() {
//     aladin.gotoObject("andromeda");
//     aladin.adjustFovForObject("andromeda");
// }, 5000);

// Various observers
        
// let canvas = document.querySelector('#aladin-lite-div');
// let canvasObserver = new MutationObserver(moveUpdateImage);        
// canvasObserver.observe(canvas, {
//     childList: true
// });
            
// let locationSelector = document.querySelector('.aladin-location');
// let locationObserver = new MutationObserver(moveUpdateImage);
// locationObserver.observe(locationSelector, {
//     childList: true
// });

// let fovSelector = document.querySelector('.aladin-fov');
// let fovObserver = new MutationObserver(moveUpdateImage);
// fovObserver.observe(fovSelector, {
//     childList: true
// });
        
</script>
</body>
</html>